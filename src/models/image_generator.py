""""
Generate embedded images in a module ready for import.

Image source:
https://www.iconsdb.com
Color: #325c81
Tree: 16px
Toolbar: 24px

"""

import base64
import glob
import os
import wx


MAX_LINE_LENGTH = 93


def generate_images():
    path = os.path.dirname(os.path.abspath(__file__))
    output_filename = os.path.join(path, "images.py")
    images_path = os.path.join(path, "artifacts", "*.png")
    output = '"""\n'
    output += "Embedded images.\n"
    output += "Generated by image_generator.py\n"
    output += '"""\n\n'
    output += "from wx.lib.embeddedimage import PyEmbeddedImage\n\n\n"

    for item in glob.glob(images_path):
        with open(item, "rb") as fp:
            data = base64.b64encode(fp.read())

        bname = os.path.basename(item)
        var_name = os.path.splitext(bname)[0].replace("-", "_").replace(" ", "_")
        output += f"{var_name} = PyEmbeddedImage(\n"

        while len(data) > MAX_LINE_LENGTH:
            line = data[:MAX_LINE_LENGTH]
            data = data[MAX_LINE_LENGTH:]
            output += f"    {line}\n"
        if len(data) > 0:
            output += f"    {data}\n"
        output += ")\n\n"

    with open(output_filename, "w", encoding="utf-8") as fp:
        fp.write(output.strip("\n") + "\n")

def test_generated_images():
    # We cannot put this import at the top.
    # If the file not yet exists, the generation will fail.
    # And to make sure we have the generated version, we need to import after generation.
    # pylint: disable=import-outside-toplevel
    import src.models.images as Images

    app = wx.App(False)
    f = wx.Frame(None, title="Images test")
    f.SetInitialSize((300, 200))
    panel = wx.Panel(f)
    box = wx.BoxSizer(wx.VERTICAL)
    panel.SetSizer(box)
    f.Show()

    i = 0
    max_per_row = 6
    sizer = None
    for attr in dir(Images):
        image = getattr(Images, attr)
        if isinstance(image, wx.lib.embeddedimage.PyEmbeddedImage):
            bmp = image.GetBitmap()
            static_bitmap = wx.StaticBitmap(panel, bitmap=bmp)
            if i == 0:
                sizer = wx.BoxSizer(wx.HORIZONTAL)
            sizer.Add(static_bitmap, 0, wx.ALL, 2)
            i += 1
            if i == max_per_row:
                box.Add(sizer, 0, wx.ALL, 2)
                sizer = wx.BoxSizer(wx.HORIZONTAL)
                i = 0
    if i > 0:
        box.Add(sizer, 0, wx.ALL, 2)
    box.Layout()

    app.MainLoop()


if __name__ == "__main__":

    generate_images()
    test_generated_images()
